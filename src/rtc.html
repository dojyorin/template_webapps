<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
    </head>

    <body>
        <button type="button" id="offer">OFFER</button>
        <button type="button" id="answer">ANSWER</button>
    </body>

    <script async type="module">
        async function $sleep(time){
            return new Promise(done => setTimeout(done, time));
        }

        async function wcHashDigest(data){
            return crypto.subtle.digest("SHA-512", data);
        }

        function toHex(data){
            return [...new Uint8Array(data?.buffer ?? data)].map(n => n.toString(16).padStart(2, "0").toUpperCase()).join("");
        }

        document.getElementById("offer").addEventListener("click", async({target})=>{
            target.textContent = "OFFERING...";

            const rtc = new RTCPeerConnection({
                iceServers: [{
                    urls: ["stun:stun.l.google.com:19302"]
                }]
            });

            const ch = rtc.createDataChannel("");

            await rtc.setLocalDescription(await rtc.createOffer());

            while(rtc.iceGatheringState !== "complete"){
                await $sleep(100);
            }

            console.log(btoa(JSON.stringify(rtc.localDescription)));

            await rtc.setRemoteDescription(JSON.parse(atob(prompt("ANSWER?"))));

            while(ch.readyState !== "open"){
                await $sleep(10);
            }

            const sample = new Uint8Array(new Float32Array(16 / 4 * 0x100000).map(() => Math.random()).buffer);
            let offset = 0;

            ch.send(`${"test"}:${sample.byteLength}:${toHex(await wcHashDigest(sample))}`);

            while(offset < sample.byteLength){
                while(ch.bufferedAmount > 0x200000){
                    await $sleep(10);
                }

                ch.send(sample.subarray(offset, offset += 0x4000));
            }

            ch.send("");
        });

        document.getElementById("answer").addEventListener("click", async({target})=>{
            target.textContent = "ANSWERING...";

            const rtc = new RTCPeerConnection({
                iceServers: [{
                    urls: ["stun:stun.l.google.com:19302"]
                }]
            });

            await rtc.setRemoteDescription(JSON.parse(atob(prompt("OFFER?"))));
            await rtc.setLocalDescription(await rtc.createAnswer());

            while(rtc.iceGatheringState !== "complete"){
                await $sleep(100);
            }

            console.log(btoa(JSON.stringify(rtc.localDescription)));

            const {channel: ch} = await new Promise(res => rtc.addEventListener("datachannel", res, {once: true}));

            let offset = 0;
            let byte = null;
            let meta = "";
            let hash = "";

            ch.addEventListener("message", async({data})=>{
                if(typeof data === "string"){
                    if(data){
                        const [m, b, h] = data.split(":");
                        byte = new Uint8Array(Number(b));
                        meta = m;
                        hash = h;
                    }
                    else{
                        ch.close();

                        if(hash !== toHex(await wcHashDigest(byte))){
                            throw new Error();
                        }

                        console.log(meta, byte.buffer);
                    }
                }
                else{
                    byte.set(new Uint8Array(data), offset);
                    offset += data.byteLength;
                }
            });
        });
    </script>
</html>