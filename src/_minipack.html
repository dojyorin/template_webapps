<!doctype html>
<meta charset="utf-8">

<script async type="module">
    /**
    * @summary esnext-polyfill
    * @return {Promise<Uint8Array>}
    */
    Blob.prototype.bytes ??= async function() {
        return new Uint8Array(await this.arrayBuffer());
    }

    /**
    * @param {File[]} files
    * @return {Promise<Uint8Array>}
    */
    async function minipackEncode(files) {
        const archive = new Uint8Array(files.reduce((n, {size}) => n + Uint32Array.BYTES_PER_ELEMENT + 0xFF + size, 0));
        const view = new DataView(archive.buffer);
        const encoder = new TextEncoder();

        for(let i = 0, j = 0; j < files.length; j++) {
            view.setUint32(i, files[j].size);
            i += Uint32Array.BYTES_PER_ELEMENT;

            archive.set(encoder.encode(files[j].name), i);
            i += 0xFF;

            archive.set(await files[j].bytes(), i);
            i += files[j].size;
        }

        return archive;
    }

    /**
    * @param {Uint8Array} archive
    * @return {Promise<File[]>}
    */
    async function minipackDecode(archive) {
        /** @type {File[]} */
        const files = [];
        const view = new DataView(archive.buffer);
        const decoder = new TextDecoder();

        for(let i = 0; i < archive.byteLength; undefined) {
            const size = view.getUint32(i);
            i += Uint32Array.BYTES_PER_ELEMENT;

            const name = decoder.decode(archive.subarray(i, i += 0xFF)).replaceAll("\0", "");

            files.push(new File([archive.slice(i, i += size)], name));
        }

        return await files;
    }

    /**
    * @param {number} size
    * @return {Uint8Array}
    */
    function _dummy(size) {
        return new Uint8Array(new Float32Array(size / 4).map(() => Math.random()).buffer);
    }

    const files = [
        new File([_dummy(1024 ** 2)], "foo"),
        new File([_dummy(1024 ** 2)], "bar"),
        new File([_dummy(1024 ** 2)], "baz")
    ];

    const encode = await minipackEncode(files);
    const decode = await minipackDecode(encode);

    console.log(encode);
    console.log(decode);
</script>