<!doctype html>
<meta charset="utf-8">

<script async type="module">
    // esnext-polyfill
    Uint8Array.prototype.toBase64 ??= function() {
        return btoa(Array.from(this, (v) => String.fromCharCode(v)).join(""));
    }

    /**
    * @template {unknown} T
    * @param {string} script
    * @param {boolean=} ts
    * @return {(message: unknown, transfers?: Transferable[]) => Promise<T>}
    */
    function factoryWorker(script, ts) {
        const source = `data:text/${ts ? "typescript" : "javascript"};base64,${new TextEncoder().encode(script.trim().replace(/(['"`])(?:\\\1|[^\\1])*?\1|\s+/sg, (m, p) => p ? m : " ")).toBase64()}`;

        return (message, transfers) => {
            return new Promise((res, rej) => {
                const worker = new Worker(source, {
                    type: "module"
                });

                worker.onmessage = ({data}) => {
                    res(data);
                    worker.terminate();
                };

                worker.onerror = (e) => {
                    rej(e);
                    worker.terminate();
                };

                worker.onmessageerror = (e) => {
                    rej(e);
                    worker.terminate();
                };

                worker.postMessage(message, {
                    transfer: transfers
                });
            });
        };
    }

    const generateDummy = factoryWorker(/*js*/`
        globalThis.onmessage = async ({data}) => {
            const sample = new Uint8Array(new Float32Array(data / 4).map(() => Math.random()).buffer);

            globalThis.postMessage(sample, {
                transfer: [sample.buffer]
            });
        };
    `);

    console.log(await generateDummy(64 * 1024 ** 2));
</script>