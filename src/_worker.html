<!doctype html>
<meta charset="utf-8">

<script async type="module">
    /**
     * @template {unknown} T
     * @template {unknown} U
     * @param {string | URL} script
     * @param {boolean} [ts]
     * @return {{runWorker(message: T, transfers?: Transferable[]): Promise<U>;}}
     */
    function factoryWorker(script, ts) {
        return {
            runWorker(message, transfers) {
                return new Promise((res, rej) => {
                    const worker = new Worker(typeof script === "string" ? `data:text/${ts ? "typescript" : "javascript"};base64,${new TextEncoder().encode(script).toBase64()}` : script, {
                        type: "module"
                    });

                    worker.onmessage = ({data}) => {
                        worker.terminate();
                        res(data);
                    };

                    worker.onerror = (e) => {
                        worker.terminate();
                        rej(e);
                    };

                    worker.onmessageerror = (e) => {
                        worker.terminate();
                        rej(e);
                    };

                    worker.postMessage(message, {
                        transfer: transfers
                    });
                });
            }
        };
    }

    /** @type {{runWorker(message: number): Promise<Uint8Array>;}} */
    const {runWorker} = factoryWorker(/*js*/`
        /**
         * @param {number} size
         * @return {Uint8Array}
         */
        function _dummy(size) {
            return new Uint8Array(new Float32Array(size / 4).map(() => Math.random()).buffer);
        }

        globalThis.onmessage = ({data}) => {
            const binary = _dummy(data);

            globalThis.postMessage(binary, {
                transfer: [binary.buffer]
            });
        };
    `);

    const binary = await runWorker(128 * 1024 ** 2);

    console.log(binary);
</script>