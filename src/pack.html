<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
    </head>

    <body>
        <input multiple type="file" id="files">
    </body>

    <script async type="module">
        function packConfigHS(){
            return {
                size: 4,
                hash: 64,
                name: 256
            };
        }

        function bufferEqual(buffer1, buffer2){
            const dv1 = new DataView(buffer1);
            const dv2 = new DataView(buffer2);

            return dv1.byteLength === dv2.byteLength && new Array(dv1.byteLength).fill(null).every((_, i) => dv1.getUint8(i) === dv2.getUint8(i));
        }

        async function cryptoHashDigest(data){
            return crypto.subtle.digest("SHA-512", data);
        }

        async function packEncode(files){
            if(files.some(({size, name}) => size > (0x100 ** packConfigHS().size) || new TextEncoder().encode(name).byteLength > packConfigHS().name)){
                throw "";
            }

            const archive = new Uint8Array(Object.values(packConfigHS()).reduce((a, b) => a + b, 0) * files.length + files.reduce((a, {size}) => a + size, 0));

            let offset = 0;
            for(const file of files){
                const data = await file.arrayBuffer();

                const dv = new DataView(new ArrayBuffer(4));
                dv.setUint32(0, file.size);

                archive.set(new Uint8Array(dv.buffer), offset);
                offset += packConfigHS().size;
                archive.set(new Uint8Array(await cryptoHashDigest(data)), offset);
                offset += packConfigHS().hash
                archive.set(new TextEncoder().encode(file.name), offset);
                offset += packConfigHS().name
                archive.set(new Uint8Array(data), offset);
                offset += file.size;
            }

            return archive.buffer;
        }

        async function packDecode(archive){
            const files = [];

            let offset = 0;
            while(offset < archive.byteLength){
                const size = new DataView(archive.slice(offset, offset += packConfigHS().size)).getUint32(0);
                const hash = archive.slice(offset, offset += packConfigHS().hash);
                const name = new TextDecoder().decode(archive.slice(offset, offset += packConfigHS().name)).replace(/\0+$/, "");
                const data = archive.slice(offset, offset += size);

                if(!bufferEqual(hash, await cryptoHashDigest(data))){
                    throw "";
                }

                files.push(new File([data], name));
            }

            return files;
        }

        document.getElementById("files").addEventListener("change", async({target: {files}})=>{
            const encode = await packEncode([...files]);
            const decode = await packDecode(encode);

            console.log(encode);
            console.log(decode);
        });
    </script>
</html>