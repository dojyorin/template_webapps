<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
    </head>

    <body></body>

    <script async type="module">
        /**
        * @typedef {object} ExportKeyPair
        * @property {Uint8Array} pub
        * @property {Uint8Array} sec
        **/

        const configEc = {
            namedCurve: "P-521"
        };

        const configEncrypt = {
            name: "AES-GCM",
            tagLength: 128
        };

        const configSign = {
            name: "ECDSA",
            hash: {
                name: "SHA-512"
            }
        };

        /**
        * @param {Uint8Array[]} bytes
        * @return {Uint8Array}
        **/
        function byteConcat(...bytes){
            const memory = new Uint8Array(bytes.reduce((a, {byteLength}) => a + byteLength, 0));

            let offset = 0;

            for(const byte of bytes){
                memory.set(byte, offset);
                offset += byte.byteLength;
            }

            return memory;
        }

        /**
        * @param {Uint8Array} data
        * @return {Promise<Uint8Array>}
        **/
        async function sha2(data){
            return new Uint8Array(await crypto.subtle.digest("SHA-512", data));
        }

        /**
        * @param {"ECDH" | "ECDSA"} name
        * @param {readonly KeyUsage[]} usage
        * @return {Promise<ExportKeyPair>}
        **/
        async function exportKey(name, usage){
            const {publicKey, privateKey} = await crypto.subtle.generateKey({...configEc, name}, true, usage);

            return {
                pub: new Uint8Array(await crypto.subtle.exportKey("spki", publicKey)),
                sec: new Uint8Array(await crypto.subtle.exportKey("pkcs8", privateKey))
            };
        }

        /**
        * @return {Promise<ExportKeyPair>}
        **/
        async function wcExportDerive(){
            return await exportKey("ECDH", ["deriveKey"]);
        }

        /**
        * @return {Promise<ExportKeyPair>}
        **/
        async function wcExportSign(){
            return await exportKey("ECDSA", ["sign", "verify"]);
        }

        /**
        * @param {Uint8Array} key
        * @param {"ECDH" | "ECDSA"} name
        * @param {KeyFormat} format
        * @param {readonly KeyUsage[]} usage
        * @return {Promise<CryptoKey>}
        **/
        async function importKey(key, name, format, usage){
            return await crypto.subtle.importKey(format, key, {...configEc, name}, false, usage);
        }

        /**
        * @param {Uint8Array} pub
        * @param {Uint8Array} sec
        * @return {Promise<CryptoKey>}
        **/
        async function wcImportDerive(pub, sec){
            return await crypto.subtle.deriveKey({
                name: "ECDH",
                public: await importKey(pub, "ECDH", "spki", [])
            }, await importKey(sec, "ECDH", "pkcs8", ["deriveKey"]), {
                name: "AES-GCM",
                length: 256
            }, false, ["encrypt", "decrypt"]);
        }

        /**
        * @param {Uint8Array} key
        * @param {KeyType} type
        * @return {Promise<CryptoKey>}
        **/
        async function wcImportSign(key, type){
            switch(type){
                case "public": return await importKey(key, "ECDSA", "spki", ["verify"]);
                case "private": return await importKey(key, "ECDSA", "pkcs8", ["sign"]);
                default: throw new Error();
            }
        }

        /**
        * @param {CryptoKey} com
        * @param {Uint8Array} data
        * @return {Promise<Uint8Array>}
        **/
        async function wcEncrypt(com, data){
            const iv = crypto.getRandomValues(new Uint8Array(12));

            return byteConcat(iv, await crypto.subtle.encrypt({...configEncrypt, iv}, com, data));
        }

        /**
        * @param {CryptoKey} com
        * @param {Uint8Array} data
        * @return {Promise<Uint8Array>}
        **/
        async function wcDecrypt(com, data){
            const iv = data.subarray(0, 12);

            return new Uint8Array(await crypto.subtle.decrypt({...configEncrypt, iv}, com, data.subarray(12)));
        }

        /**
        * @param {Uint8Array} sec
        * @param {Uint8Array} data
        * @return {Promise<Uint8Array>}
        **/
        async function wcSign(sec, data){
            return new Uint8Array(crypto.subtle.sign(configSign, await wcImportSign(sec, "private"), data));
        }

        /**
        * @param {Uint8Array} sign
        * @param {Uint8Array} pub
        * @param {Uint8Array} data
        * @return {Promise<boolean>}
        **/
        async function wcVerify(sign, pub, data){
            return crypto.subtle.verify(configSign, await wcImportSign(pub, "public"), sign, data);
        }

        /**
        * @param {Uint8Array} data
        * @return {string}
        **/
        function b2h(data){
            return [...data].map(n => n.toString(16).toUpperCase().padStart(2, "0")).join("");
        }

        const sample = new TextEncoder().encode("hogehoge");

        const keyDerive1 = await wcExportDerive();
        const keyDerive2 = await wcExportDerive();
        const keySign = await wcExportSign();

        const keyCommon1P2S = await wcImportDerive(keyDerive1.pub, keyDerive2.sec);
        const keyCommon2P1S = await wcImportDerive(keyDerive2.pub, keyDerive1.sec);

        const encode = await wcEncrypt(keyCommon1P2S, sample);
        const decode = await wcDecrypt(keyCommon2P1S, encode);

        const sign = await wcSign(keySign.sec, sample);
        const verify = await wcVerify(keySign.pub, sign, decode);

        const hash1 = await sha2(sample);
        const hash2 = await sha2(decode);

        console.log("---------- Exported Derive Keys ----------");
        console.log(keyDerive1.pub);
        console.log(keyDerive1.sec);
        console.log(keyDerive2.pub);
        console.log(keyDerive2.sec);

        console.log("---------- Exported Sign Keys ----------");
        console.log(keySign.pub);
        console.log(keySign.sec);

        console.log("---------- Derived Common Keys ----------");
        console.log(keyCommon1P2S);
        console.log(keyCommon2P1S);

        console.log("---------- Sample Data ----------");
        console.log(new TextDecoder().decode(sample));

        console.log("---------- Encoded Data ----------");
        console.log(new TextDecoder().decode(encode));

        console.log("---------- Decoded Data ----------");
        console.log(new TextDecoder().decode(decode));

        console.log("---------- Data Signature ----------");
        console.log(sign);

        console.log("---------- Signature Verify Result ----------");
        console.log(verify);

        console.log("---------- Raw Hash ----------");
        console.log(b2h(hash1));

        console.log("---------- Decoded Hash ----------");
        console.log(b2h(hash2));
    </script>
</html>