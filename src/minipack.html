<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
    </head>

    <body>
        <input multiple type="file" id="files">
    </body>

    <script async type="module">
        const size = {
            hash: 32,
            name: 1,
            body: 4
        };

        const sizeTotal = Object.values(size).reduce((a, c) => a + c, 0);

        /**
        * @param {Uint8Array} data;
        * @returns {Uint8Array};
        **/
        async function sha2(data){
            return new Uint8Array(await crypto.subtle.digest("SHA-256", data));
        }

        /**
        * @param {string} data;
        * @returns {Uint8Array};
        **/
        function s2b(data){
            return new TextEncoder().encode(data);
        }

        /**
        * @param {Uint8Array} data;
        * @returns {string};
        **/
        function b2s(data){
            return new TextDecoder().decode(data);
        }

        /**
        * @param {File[]} files;
        * @returns {Uint8Array};
        **/
        async function minipackEncode(files){
            const archive = new Uint8Array(files.reduce((a, {size: s, name: n}) => a + sizeTotal + s2b(n).byteLength + s, 0));

            let offset = 0;

            for(const file of files){
                const name = s2b(file.name);
                const body = new Uint8Array(await file.arrayBuffer());

                archive.set(await sha2(body), offset);
                offset += size.hash;

                new DataView(archive.buffer, offset).setUint8(0, name.byteLength);
                offset += size.name;

                new DataView(archive.buffer, offset).setUint32(0, body.byteLength);
                offset += size.body;

                archive.set(name, offset);
                offset += name.byteLength;

                archive.set(body, offset);
                offset += body.byteLength;
            }

            return archive;
        }

        /**
        * @param {Uint8Array} archive;
        * @returns {File[]};
        **/
        async function minipackDecode(archive){
            /**
            * @type {File[]};
            **/
            const files = [];

            let offset = 0;

            while(offset < archive.byteLength){
                const hash = archive.subarray(offset, offset += size.hash);

                const ns = new DataView(archive.buffer, offset).getUint8(0);
                offset += size.name;

                const bs = new DataView(archive.buffer, offset).getUint32(0);
                offset += size.body;

                const name = b2s(archive.subarray(offset, offset += ns));

                const body = archive.subarray(offset, offset += bs);

                if(hash.toString() !== (await sha2(body)).toString()){
                    throw new Error();
                }

                files.push(new File([body], name));
            }

            return files;
        }

        document.getElementById("files").addEventListener("change", async({target: {files}})=>{
            const encode = await minipackEncode([...files]);
            const decode = await minipackDecode(encode);

            console.log(encode);
            console.log(decode);
        });
    </script>
</html>