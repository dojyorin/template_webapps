<!doctype html>
<meta charset="utf-8">

<script async type="module">
    /**
     * @typedef {{name: string; body: Uint8Array<ArrayBuffer>; timestamp?: number; permission?: number; uid?: number; gid?: number;}} FileEx
     */

    /**
     * @param {FileEx[]} files
     * @return {Uint8Array<ArrayBuffer>}
     */
    function entar(files) {
        const BLOCK_SIZE = 512;

        const encoder = new TextEncoder();

        const bufs = files.map((file) => {
            const buf = new Uint8Array(BLOCK_SIZE + file.body.byteLength + (BLOCK_SIZE - file.body.byteLength % BLOCK_SIZE));

            buf.set(encoder.encode(file.name).subarray(0, 99), 0);
            buf.set(encoder.encode((file.permission ?? 0o644).toString(8).padStart(7)).subarray(0, 7), 100);
            buf.set(encoder.encode((file.uid ?? 0).toString(8).padStart(7)).subarray(0, 7), 108);
            buf.set(encoder.encode((file.gid ?? 0).toString(8).padStart(7)).subarray(0, 7), 116);
            buf.set(encoder.encode(file.body.byteLength.toString(8).padStart(11)).subarray(0, 11), 124);
            buf.set(encoder.encode((file.timestamp ?? Math.floor(Date.now() / 1000)).toString(8).padStart(11)).subarray(0, 11), 136);
            buf.set(encoder.encode("0"), 156);
            buf.set(encoder.encode("ustar"), 257);
            buf.set(encoder.encode("00"), 263);
            buf.set(encoder.encode(buf.subarray(0, BLOCK_SIZE).reduce((v, n, i) => 147 < i && i < 156 ? v + 0x20 : v + n, 0).toString(8).padEnd(8)).subarray(0, 8), 148);
            buf.set(file.body, BLOCK_SIZE);

            return buf;
        });

        const output = new Uint8Array(bufs.reduce((v, {byteLength}) => v + byteLength, 0) + BLOCK_SIZE * 2);
        let offset = 0;

        for (const buf of bufs) {
            output.set(buf, offset);
            offset += buf.byteLength;
        }

        return output;
    }

    /**
     * @param {Uint8Array<ArrayBuffer>} tar
     * @return {NonNullable<FileEx>[]}
     */
    function untar(tar) {
        const BLOCK_SIZE = 512;

        const decoder = new TextDecoder();

        /** @type {Uint8Array<ArrayBuffer>[]} */
        const bufs = [];
        let offset = 0;

        while (offset < tar.byteLength - BLOCK_SIZE * 2) {
            const size = parseInt(decoder.decode(tar.subarray(offset + 124, offset + 135)), 8);

            bufs.push(tar.slice(offset, offset += BLOCK_SIZE + size + (BLOCK_SIZE - size % BLOCK_SIZE)));
        }

        return bufs.map((buf) => {
            const name = decoder.decode(buf.subarray(0, 99)).replaceAll("\0", "");
            const permission = parseInt(decoder.decode(buf.subarray(100, 107)), 8);
            const uid = parseInt(decoder.decode(buf.subarray(108, 115)), 8);
            const gid = parseInt(decoder.decode(buf.subarray(116, 123)), 8);
            const size = parseInt(decoder.decode(buf.subarray(124, 135)), 8);
            const timestamp = parseInt(decoder.decode(buf.subarray(136, 147)), 8);
            const checksum = parseInt(decoder.decode(buf.subarray(148, 154)), 8);
            const type = decoder.decode(buf.subarray(156, 157));
            const magic = decoder.decode(buf.subarray(257, 262));
            const body = buf.slice(BLOCK_SIZE, BLOCK_SIZE + size);

            if (magic !== "ustar") {
                throw new ReferenceError("Invalid tar magic.");
            } else if (checksum !== buf.subarray(0, BLOCK_SIZE).reduce((v, n, i) => 147 < i && i < 156 ? v + 0x20 : v + n, 0)) {
                throw new ReferenceError("Invalid tar checksum.");
            }

            return {
                name: name,
                body: ["0", "\0"].includes(type) ? body : new Uint8Array(0),
                timestamp: timestamp,
                permission: permission,
                uid: uid,
                gid: gid
            };
        });
    }

    /**
     * @param {number} size
     * @return {Uint8Array<ArrayBuffer>}
     */
    function _dummy(size) {
        return new Uint8Array(new Float32Array(size / 4).map(() => Math.random()).buffer);
    }

    /** @type {FileEx[]} */
    const samples = [{
        name: "foo",
        body: _dummy(1024 ** 2)
    }, {
        name: "bar",
        body: _dummy(1024 ** 2)
    }];

    const encode = entar(samples);
    const decode = untar(encode);

    console.log(encode);
    console.log(decode);
</script>