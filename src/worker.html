<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
    </head>

    <body></body>

    <script async type="module">
        class WorkerExtend extends Worker{
            static #fnStart = /^.+?\{/s;
            static #fnEnd = /\}$/s;

            #path = "";

            /**
            * @param {...VoidFunction} fns
            */
            constructor(...fns){
                const srcs = fns.map(fn => fn.toString());

                if(srcs.some(src => !WorkerExtend.#fnEnd.test(src))){
                    throw new Error();
                }

                const path = URL.createObjectURL(new Blob([srcs.map(src => src.replace(WorkerExtend.#fnStart, "").replace(WorkerExtend.#fnEnd, "")).join(";")]));

                super(path);

                this.#path = path;
            }

            terminate(){
                super.terminate();
                URL.revokeObjectURL(this.#path);
            }
        }

        const worker = new WorkerExtend(()=>{
            globalThis.onmessage = ({data})=>{
                const sample = data.map(n => n * 2);
                globalThis.postMessage(sample, [sample.buffer]);
            };
        });

        worker.onmessage = ({data})=>{
            console.log(data);
            worker.terminate();
        };

        const sample = new Uint8Array(new Float32Array(0x00400000).map(() => Math.random()).buffer);
        worker.postMessage(sample, [sample.buffer]);
    </script>
</html>