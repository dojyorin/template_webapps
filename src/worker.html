<!doctype html>
<meta charset="utf-8">

<script async type="module">
    class InlineWorker extends Worker{
        #path = "";

        /**
        * @param {VoidFunction} f
        */
        constructor(f){
            const source = f.toString();
            const path = URL.createObjectURL(new Blob([source.replace(/^.+?{/s, "").replace(/}$/s, "")]));
            super(path);
            this.#path = path;
        }

        terminate(){
            super.terminate();
            URL.revokeObjectURL(this.#path);
        }
    }

    const worker = new InlineWorker(()=>{
        globalThis.onmessage = ({data})=>{
            const sample = data.map(n => n * 2);
            globalThis.postMessage(sample, [sample.buffer]);
        };
    });

    worker.onmessage = ({data})=>{
        console.log(data);
        worker.terminate();
    };

    const sample = new Uint8Array(new Float32Array(0x00400000).map(() => Math.random()).buffer);
    worker.postMessage(sample, [sample.buffer]);
</script>

<main></main>