<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
        <meta name="referrer" content="no-referrer">

        <title>WebWorker</title>
    </head>

    <body>
        Web Worker API
    </body>

    <script async type="module">
        class WorkerInline extends Worker{
            #ctx = "";

            constructor(...srcs){
                const ctx = URL.createObjectURL(new Blob([srcs.map(src => src.toString().replace(/^.+?\{/s, "").replace(/\}$/s, "")).join(";")]));
                super(ctx);
                this.#ctx = ctx;
            }

            terminate(){
                super.terminate();
                URL.revokeObjectURL(this.#ctx);
            }
        }

        const worker = new WorkerInline(()=>{
            globalThis.addEventListener("message", ({data})=>{
                globalThis.postMessage(data, [data.buffer]);
            });
        });

        worker.addEventListener("message", ({data})=>{
            worker.terminate();
            console.log(data);
        });

        const bytes = new Uint8Array(1024 * 1024 * 128);

        worker.postMessage(bytes, [bytes.buffer]);
    </script>
</html>