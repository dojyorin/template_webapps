<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
        <meta name="referrer" content="no-referrer">

        <title>WebSerial</title>
    </head>

    <body>
        <button type="button" id="connect">Connect!</button>
    </body>

    <script async type="module">
        class LbTransformStream extends TransformStream{
            constructor(){
                let container = "";

                super({
                    transform(chunk, controller){
                        container += chunk;
                        const lines = container.split(/\n/);
                        container = lines.pop();

                        for(const line of lines){
                            controller.enqueue(line);
                        }
                    }
                });
            }
        }

        document.getElementById("connect").addEventListener("click", async()=>{
            const serial = await navigator.serial.requestPort();

            await serial.open({
                baudRate: 115200,
                dataBits: 8,
                stopBits: 1,
                parity: "none",
                bufferSize: 255,
                flowControl: "none"
            });

            let reader = null;

            setInterval(async()=>{
                if(!serial.readable.locked){
                    reader = serial.readable.pipeThrough(new TextDecoderStream()).pipeThrough(new LbTransformStream()).getReader();
                }

                try{
                    console.log((await reader.read()).value);
                }
                catch{
                    console.error("error");
                }
            }, 500);
        });
    </script>
</html>