<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, height=device-height, minimum-scale=1, maximum-scale=1, initial-scale=1, user-scalable=no">
        <meta name="referrer" content="no-referrer">

        <title>I/O</title>
    </head>

    <body>
        <button type="button" id="read">Read</button>
        <button type="button" id="write">Write</button>
        <button type="button" id="directory">Directory</button>
    </body>

    <script async type="module">
        function $id(id){
            return document.getElementById(id);
        }

        async function fsRead(type, multiple, accept){
            return new Promise((resolve)=>{
                const input = document.createElement("input");
                input.type = "file";
                input.multiple = !!multiple;
                input.accept = accept ?? "";

                input.addEventListener("input", async()=>{
                    resolve(await Promise.all(Array.from(input.files).map(async(file)=>{
                        return {
                            name: file.name,
                            data: {
                                blob: new Blob([file]),
                                buffer: await file.arrayBuffer(),
                                text: await file.text(),
                                code: await new Promise((res)=>{
                                    const reader = new FileReader();
                                    reader.addEventListener("load", () => res(reader.result));
                                    reader.readAsDataURL(file);
                                })
                            }[type ?? "buffer"]
                        };
                    })));
                });

                input.click();
            });
        }

        function fsWrite(name, data){
            const anchor = document.createElement("a");
            anchor.download = name;
            anchor.href = URL.createObjectURL(new Blob([data]));

            anchor.click();

            URL.revokeObjectURL(anchor.href);
        }

        async function fsNativeRead(fs, type){
            const handle = fs instanceof FileSystemFileHandle ? fs : (await showOpenFilePicker(fs)).shift();
            const file = await handle.getFile();

            return {
                fs: handle,
                data: {
                    blob: new Blob([file]),
                    buffer: await file.arrayBuffer(),
                    text: await file.text(),
                    code: await new Promise((res)=>{
                        const reader = new FileReader();
                        reader.addEventListener("load", () => res(reader.result));
                        reader.readAsDataURL(file);
                    })
                }[type ?? "buffer"]
            };
        }

        async function fsNativeWrite(fs, data){
            const handle = fs instanceof FileSystemFileHandle ? fs : await showSaveFilePicker(fs);
            const writer = await handle.createWritable();

            await writer.write(data);
            await writer.close();

            return {
                fs: handle
            };
        }

        async function fsNativeDirectory(){
            const handle = await showDirectoryPicker();

            return {
                fs: handle
            };
        }

        function dialogNotify(message){
            const dialog = document.createElement("dialog");
            dialog.style.position = "fixed";
            dialog.style.top = "10px";
            dialog.style.transition = "all 0.1s";
            dialog.style.border = "0";
            dialog.style.borderRadius = "8px";
            dialog.style.padding = "10px 15px";
            dialog.style.backgroundColor = "#CACACA";
            dialog.style.boxShadow = "2px 3px 4px 0 #0000004D";
            dialog.textContent = `\u{1F514} ${message}`;

            dialog.show();

            setTimeout(() => dialog.remove(), 5000);
            document.body.appendChild(dialog);
        }

        $id("read").addEventListener("click", async()=>{
            console.log(await fsRead());
            console.log(await fsNativeRead());
            dialogNotify("Loaded!");
        });

        $id("write").addEventListener("click", async()=>{
            console.log(await fsWrite("test.txt", "test"));
            console.log(await fsNativeWrite(null, "test"));
            dialogNotify("Saved!");
        });

        $id("directory").addEventListener("click", async()=>{
            console.log(await fsNativeDirectory());
            dialogNotify("Loaded!");
        });
    </script>
</html>